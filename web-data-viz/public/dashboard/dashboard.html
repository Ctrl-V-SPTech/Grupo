<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaTech | Dashboard Sensor</title>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <link rel="stylesheet" href="../css/dashindividual.css">
    <link rel="stylesheet" href="../css/estilo.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="sidebar" class="sidebar">
        <a href="">Usuário</a><br /><br /><br />
        <a href="dashboardgeral.html" id="navestufa">Estufas</a><br />
        <a href="../cadastrousuario.html" id="navcadastro">Cadastrar Usuario</a><br /><br /><br /><br />
        <a href="index.html" id="navbobia">BobIA</a> <br>
        <a href="https://controledeuvas.atlassian.net/servicedesk/customer/portal/1">Suporte</a> <br>
        <a href="../">Sair</a>
    </div>

    <div id="main">
        <div class="dashboard-grid">
            <!-- Cards -->
            <div class="sensor-card">
                <div class="header">
                    <div class="legend">
                        <div class="item"><span class="dot ideal"></span> Ideal</div>
                        <div class="item"><span class="dot moderado" title="Alerta moderado"></span> Moderado</div>
                        <div class="item"><span class="dot critico" title="Alerta crítico"></span> Crítico</div>
                    </div>
                    <h4>
                        Temperatura e umidade em tempo real:
                        <span id="fase-atual" style="font-weight: normal; font-size: .9rem; margin-left: 8px;">
                            <!-- Fase aparece aqui -->
                        </span>
                    </h4>
                </div>
                <div class="values">
                    <div class="temp" id="temp">
                        <img class="metricas" src="../assets/temperature.png" alt="" />--°C
                    </div>
                    <div class="umi" id="umi">
                        <img class="metricas" src="../assets/humidity.png" alt="" />--%
                    </div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="monitoring-Chart">
                <canvas id="monitoringChart"></canvas>
            </div>
            <div class="monitoring-Chart2">
                <canvas id="monitoringChart2"></canvas>
            </div>

            <div class="qtdalertas">
                <div class="qtdalertas-header">
                    Quantidade e tempo alerta (últimos 7 dias)
                </div>
                <span id="qtdmoderado" class="qtdmoderado">
                    Moderado: 0 <br />
                    --
                </span>
                <span id="qtdcritico" class="qtdcritico">
                    Crítico: 0 <br />
                    --
                </span>
                <span id="qtdtotal" class="qtdtotal">
                    Total: 0 <br />
                    --
                </span>
            </div>

            <div class="historico">
                <div class="historico-header">Histórico de alertas</div>
                <div class="historico-body" id="historico-body">
                    <div class="historico-row title">
                        <span>Data e Hora</span>
                        <span>Mensagem</span>
                        <span>Status</span>
                        <span>Tempo em alerta</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>

    
    // ========== VARIÁVEIS GLOBAIS ==========
    // Suporta tanto sessionStorage quanto URL (?sensor=2)
    const urlParams = new URLSearchParams(window.location.search);
    const ID_ESTUFA = sessionStorage.getItem("ID_ESTUFA") || 1;
    const ID_SENSOR = sessionStorage.getItem("ID_SENSOR") || 1;
    
    console.log(`Abrindo Dashboard - Estufa: ${ID_ESTUFA}, Sensor: ${ID_SENSOR}`);

    let faseAtual = "Dormência";
    let proximaAtualizacao;

    const fkResponsavel = sessionStorage.FK_RESPONSAVEL;
const fkEmpresa = sessionStorage.FK_EMPRESA

if (fkResponsavel != "null") {
    document.getElementById("navcadastro").style.display = "none";
    document.getElementById("navbobia").style.display = "none";
} 

if (fkEmpresa != "null") {
   document.getElementById("navbobia").style.display = "none";
}


    // ========== FUNÇÕES UTILITÁRIAS ==========
    function redirecionar() {
        window.location.href = "http://localhost:8080/";
    }

    // ÚNICA função de formatação necessária - só para exibição
    const formatadorBR = new Intl.DateTimeFormat('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZone: 'America/Sao_Paulo'
    });

    function formatarDataHora(dataHora) {
        const d = new Date(dataHora);
        if (isNaN(d.getTime())) {
            console.error("Data inválida recebida:", dataHora);
            return "Data inválida";
        }
        return formatadorBR.format(d);
    }

    function obterFaixasPorFase(fase) {
        const faixas = {
            'Brotação': { tMin: 15, tMax: 25, uMin: 60, uMax: 80 },
            'Crescimento': { tMin: 20, tMax: 25, uMin: 60, uMax: 80 },
            'Dormência': { tMin: 5, tMax: 15, uMin: 50, uMax: 70 },
            'Floração': { tMin: 18, tMax: 25, uMin: 50, uMax: 70 },
            'Maturação': { tMin: 20, tMax: 30, uMin: 40, uMax: 60 },
            'Colheita': { tMin: 10, tMax: 20, uMin: 80, uMax: 90 }
        };
        return faixas[fase] || faixas['Dormência'];
    }

    function classificarValor(valor, min, max) {
        if (valor < min || valor > max) {
            return "CRÍTICO";
        }
        
        const centro = (min + max) / 2;
        const faixa = max - min;
        const margemModerado = faixa * 0.25;
        const distanciaDoCentro = Math.abs(valor - centro);
        
        if (distanciaDoCentro > margemModerado) {
            return "MODERADO";
        }
        
        return "IDEAL";
    }

    // ========== INICIALIZAÇÃO DOS GRÁFICOS ==========
    let dadosTemp = {
        labels: [],
        datasets: [{
            label: 'Temperatura (°C)',
            data: [],
            fill: false,
            borderColor: 'purple',
            backgroundColor: 'purple',
            tension: 0.2
        }]
    };

    let dadosUmid = {
        labels: [],
        datasets: [{
            label: 'Umidade (%)',
            data: [],
            fill: false,
            borderColor: 'blue',
            backgroundColor: 'blue',
            tension: 0.2
        }]
    };

    const configTemp = {
        type: 'line',
        data: dadosTemp,
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    };

    const configUmid = {
        type: 'line',
        data: dadosUmid,
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    };

    let chartTemp;
    let chartUmid;

    // ========== FUNÇÕES DE INTERFACE ==========
    function atualizarCards(temp, umid) {
        const faixas = obterFaixasPorFase(faseAtual);
        const statusTemp = classificarValor(temp, faixas.tMin, faixas.tMax);
        const statusUmid = classificarValor(umid, faixas.uMin, faixas.uMax);

        const tempDiv = document.getElementById("temp");
        const umidDiv = document.getElementById("umi");

        tempDiv.innerHTML = `<img class="metricas" src="../assets/temperature.png" alt="" />${Number(temp).toFixed(1)}°C`;
        umidDiv.innerHTML = `<img class="metricas" src="../assets/humidity.png" alt="" />${Number(umid).toFixed(1)}%`;

        tempDiv.className = "temp";
        umidDiv.className = "umi";
        
        if (statusTemp === "CRÍTICO") {
            tempDiv.classList.add("critico");
        } else if (statusTemp === "MODERADO") {
            tempDiv.classList.add("moderado");
        } else {
            tempDiv.classList.add("ideal");
        }

        if (statusUmid === "CRÍTICO") {
            umidDiv.classList.add("critico");
        } else if (statusUmid === "MODERADO") {
            umidDiv.classList.add("moderado");
        } else {
            umidDiv.classList.add("ideal");
        }

        console.log("Cards atualizados - Temp:", statusTemp, "Umid:", statusUmid);
    }

    function atualizarQtdAlertas(moderado, critico) {
        document.getElementById("qtdmoderado").innerHTML = `Moderado: ${moderado}<br>--`;
        document.getElementById("qtdcritico").innerHTML = `Crítico: ${critico}<br>--`;
        document.getElementById("qtdtotal").innerHTML = `Total: ${moderado + critico}<br>--`;
    }

    function limparHistoricoAlertas() {
        const historicoBody = document.getElementById("historico-body");
        historicoBody.querySelectorAll(".historico-row.dados").forEach(l => l.remove());
    }

    function adicionarLinhaHistorico(mensagem, status, horario) {
        const dataFormatada = formatarDataHora(horario);
        const horarioComQuebra = dataFormatada.replace(/(.{10})/g, "$1<br>");
        
        const row = document.createElement("div");
        row.className = "historico-row dados";
        row.innerHTML = `<span>${horarioComQuebra}</span><span>${mensagem}</span><span>${status}</span><span>—</span>`;
        
        document.getElementById("historico-body").appendChild(row);
    }

    // ========== FUNÇÕES DE FASE DA ESTUFA ==========
    function obterFaseEstufa(idEstufa) {
        fetch(`/estufas/${idEstufa}/fase-atual`, { cache: "no-store" })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (dados) {
                        const registro = Array.isArray(dados) ? dados[0] : dados;
                        const faseApi = registro?.periodoDesenvolvimento;
                        
                        if (faseApi) {
                            faseAtual = faseApi;
                            document.getElementById("fase-atual").textContent = faseAtual;
                        }
                    });
                } else {
                    console.error("Erro ao buscar fase da estufa");
                }
            })
            .catch(function (erro) {
                console.error("Erro ao obter fase da estufa:", erro);
            });
    }

    // ========== FUNÇÕES DE ALERTAS ==========
    function verificarAlertasSensor(temp, umid) {
        temp = Number(temp);
        umid = Number(umid);
        if (isNaN(temp) || isNaN(umid)) return;

        const faixas = obterFaixasPorFase(faseAtual);
        const statusTemp = classificarValor(temp, faixas.tMin, faixas.tMax);
        const statusUmid = classificarValor(umid, faixas.uMin, faixas.uMax);

        console.log(`Verificando alertas - Fase: ${faseAtual}, Temp: ${temp}°C (${statusTemp}), Umid: ${umid}% (${statusUmid})`);

        atualizarCards(temp, umid);

        if (statusTemp !== "IDEAL") {
            let mensagemTemp = "";
            
            if (statusTemp === "CRÍTICO") {
                mensagemTemp = `[${faseAtual}] Temperatura (${temp.toFixed(1)}°C) fora da faixa ideal (${faixas.tMin}°C - ${faixas.tMax}°C)`;
            } else if (statusTemp === "MODERADO") {
                mensagemTemp = `[${faseAtual}] Temperatura (${temp.toFixed(1)}°C) próxima da faixa ideal`;
            }

            registrarAlertaNoServidor({
                alertaTemp: statusTemp,
                alertaUmid: null,
                fkSensorMedida: ID_SENSOR,
                mensagem: mensagemTemp
            });
        }

        if (statusUmid !== "IDEAL") {
            let mensagemUmid = "";
            
            if (statusUmid === "CRÍTICO") {
                mensagemUmid = `[${faseAtual}] Umidade (${umid.toFixed(1)}%) fora da faixa ideal (${faixas.uMin}% - ${faixas.uMax}%)`;
            } else if (statusUmid === "MODERADO") {
                mensagemUmid = `[${faseAtual}] Umidade (${umid.toFixed(1)}%) próxima da faixa ideal`;
            }

            registrarAlertaNoServidor({
                alertaTemp: null,
                alertaUmid: statusUmid,
                fkSensorMedida: ID_SENSOR,
                mensagem: mensagemUmid
            });
        }

        if (statusTemp !== "IDEAL" || statusUmid !== "IDEAL") {
            setTimeout(() => carregarHistoricoDoServidor(), 500);
        }
    }

    function registrarAlertaNoServidor(alerta) {
        console.log(" ENVIANDO ALERTA ");
        console.log(JSON.stringify(alerta, null, 2));
        
        fetch("/alertas/registrar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(alerta)
        })
        .then(function (res) {
            if (res.ok) {
                res.text().then(texto => console.log(" Alerta registrado:", texto));
            } else {
                res.text().then(texto => console.error(` Falha: ${res.status} ${texto}`));
            }
        })
        .catch(err => console.error("✗ Erro:", err));
    }

    function carregarHistoricoDoServidor() {
        fetch(`/alertas/sensor/${ID_SENSOR}`, { cache: "no-store" })
            .then(function (res) {
                if (res.ok) {
                    res.json().then(function (lista) {
                        limparHistoricoAlertas();

                        let contadorModerado = 0;
                        let contadorCritico = 0;

                        lista.reverse();
                        lista.forEach(function (item) {
                            const alertaTemp = item.AlertaTemp || item.alertaTemp;
                            const alertaUmid = item.AlertaUmid || item.alertaUmid;
                            
                            let status = "MODERADO";
                            
                            if (alertaTemp) {
                                const tempStr = String(alertaTemp).toUpperCase().trim();
                                if (tempStr === "CRÍTICO" || tempStr === "CRITICO") {
                                    status = "CRÍTICO";
                                }
                            }
                            
                            if (alertaUmid) {
                                const umidStr = String(alertaUmid).toUpperCase().trim();
                                if (umidStr === "CRÍTICO" || umidStr === "CRITICO") {
                                    status = "CRÍTICO";
                                }
                            }

                            if (status === "CRÍTICO") {
                                contadorCritico++;
                            } else {
                                contadorModerado++;
                            }

                            let mensagem = item.mensagem || "Sem mensagem";
                            adicionarLinhaHistorico(mensagem, status, item.dtHrInicialAlerta);
                        });

                        atualizarQtdAlertas(contadorModerado, contadorCritico);
                    });
                }
            })
            .catch(err => console.error("Erro ao carregar histórico:", err));
    }

    // ========== FUNÇÕES DE DADOS DO SENSOR ==========
    function obterDadosGrafico(idEstufa, idSensor) {
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

fetch(`/medidas/ultimas/${idEstufa}/${idSensor}`, { cache: 'no-store' })
    .then(function (response) {

        if (response.status === 204) {
            console.warn("Nenhuma medida encontrada para este sensor.");
            return []; 
        }

        if (response.ok) {
            return response.json();
        } else {
            throw new Error("Erro na resposta da API");
        }
    })
    .then(function (resposta) {

        if (resposta.length === 0) {
            console.warn("Sem dados para plotar.");
            return;
        }

        resposta.reverse();
        plotarGrafico(resposta, idEstufa, idSensor);
    })
    .catch(error => console.error(`Erro: ${error.message}`));
    }

    function plotarGrafico(resposta, idEstufa, idSensor) {
        dadosTemp.labels = [];
        dadosTemp.datasets[0].data = [];
        dadosUmid.labels = [];
        dadosUmid.datasets[0].data = [];

        for (let i = 0; i < resposta.length; i++) {
            const registro = resposta[i];
            dadosTemp.labels.push(registro.dataHora);
            dadosTemp.datasets[0].data.push(Number(registro.medidaTemp));
            dadosUmid.labels.push(registro.dataHora);
            dadosUmid.datasets[0].data.push(Number(registro.medidaUmid));
        }

        chartTemp = new Chart(document.getElementById("monitoringChart"), configTemp);
        chartUmid = new Chart(document.getElementById("monitoringChart2"), configUmid);

        const ultimo = resposta[resposta.length - 1];
        atualizarCards(Number(ultimo.medidaTemp), Number(ultimo.medidaUmid));

        setTimeout(() => atualizarGrafico(idEstufa, idSensor), 2000);
    }

    function atualizarGrafico(idEstufa, idSensor) {
        fetch(`/medidas/tempo-real/${idEstufa}/${idSensor}`, { cache: 'no-store' })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (novoRegistro) {
                        if (novoRegistro.length === 0) {
                            proximaAtualizacao = setTimeout(() => atualizarGrafico(idEstufa, idSensor), 2000);
                            return;
                        }

                        const novo = novoRegistro[0];

                        if (novo.dataHora != dadosTemp.labels[dadosTemp.labels.length - 1]) {
                            if (dadosTemp.labels.length >= 7) {
                                dadosTemp.labels.shift();
                                dadosTemp.datasets[0].data.shift();
                                dadosUmid.labels.shift();
                                dadosUmid.datasets[0].data.shift();
                            }

                            dadosTemp.labels.push(novo.dataHora);
                            dadosTemp.datasets[0].data.push(Number(novo.medidaTemp));
                            dadosUmid.labels.push(novo.dataHora);
                            dadosUmid.datasets[0].data.push(Number(novo.medidaUmid));

                            chartTemp.update();
                            chartUmid.update();

                            atualizarCards(Number(novo.medidaTemp), Number(novo.medidaUmid));
                            verificarAlertasSensor(Number(novo.medidaTemp), Number(novo.medidaUmid));
                        }

                        proximaAtualizacao = setTimeout(() => atualizarGrafico(idEstufa, idSensor), 2000);
                    });
                } else {
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idEstufa, idSensor), 2000);
                }
            })
            .catch(error => {
                console.error(`Erro: ${error.message}`);
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idEstufa, idSensor), 2000);
            });
    }

    // ========== INICIALIZAÇÃO ==========
    window.onload = function () {
        obterFaseEstufa(ID_ESTUFA);
        carregarHistoricoDoServidor();
        obterDadosGrafico(ID_ESTUFA, ID_SENSOR);

        setInterval(() => obterFaseEstufa(ID_ESTUFA), 20000);
        setInterval(() => carregarHistoricoDoServidor(), 10000);
    };
</script>

</body>

</html>