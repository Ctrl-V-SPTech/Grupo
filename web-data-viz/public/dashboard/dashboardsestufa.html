<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Estufa</title>
  <link rel="stylesheet" href="../css/dashboardsestufa.css" />
  <link rel="icon" href="../public/assets/icon/Logo.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="sidebar" class="sidebar">
        <a href="">Usu√°rio</a><br /><br /><br />
        <a href="dashboardgeral.html">Estufas</a><br />
        <a href="../cadastrousuario.html">Cadastrar Usuario</a><br /><br /><br /><br />
        <a href="index.html">BobIA</a>
        <a href="../">Sair</a>
    </div>

  <div class="containerpai">
    <div class="mapaEstufa">
      <div class="mapaEstufaContent">
        <div class="container1">
          <img src="../imagens_uvas/estufa.png" class="img-estufa" />
          <div class="titulo">Sensores dentro da Estufa</div>
          <div class="status">
            <div class="statusTitulo">Status dos Alarmes</div>
            <br />
            <div class="statusVerde">
              <div class="identificacaoStatusVerde"></div>
              <div><b>Ideal</b></div>
            </div>
            <div class="statusAmarelo">
              <div class="identificacaoStatusAmarelo"></div>
              <div><b>Moderado</b></div>
            </div>
            <div class="statusVermelho">
              <div class="identificacaoStatusVermelho"></div>
              <div><b>Cr√≠tico</b></div>
            </div>
          </div>
        </div>

        <div class="container2">
          <!-- ZONA LESTE -->
          <div class="zonaLeste">
            <div class="sensoresZonas">
              <div class="primeiraLinha1">
                <a href="#" class="sensorVerde" id="um" onclick="abrirSensor(1)"><b>Sensor<br />1</b></a>
                <a href="#" class="sensorVerde" id="dois" onclick="abrirSensor(2)"><b>Sensor<br />2</b></a>
              </div>
              <br />
              <div class="segundaLinha1">
                <a href="#" class="sensorVerde" id="tres" onclick="abrirSensor(3)"><b>Sensor<br />3</b></a>
              </div>
              <br />
              <div class="terceiraLinha1">
                <a href="#" class="sensorVerde" id="quatro" onclick="abrirSensor(4)"><b>Sensor<br />4</b></a>
                <a href="#" class="sensorVerde" id="cinco" onclick="abrirSensor(5)"><b>Sensor<br />5</b></a>
              </div>
            </div>
          </div>

          <!-- ZONA CENTRAL -->
          <div class="zonaCentral">
            <div class="sensoresZonas">
              <div class="primeiraLinha2">
                <a href="#" class="sensorVerde" id="seis" onclick="abrirSensor(6)"><b>Sensor<br />6</b></a>
              </div>
              <br />
              <div class="segundaLinha2">
                <a href="#" class="sensorVerde" id="sete" onclick="abrirSensor(7)"><b>Sensor<br />7</b></a>
                <a href="#" class="sensorVerde" id="oito" onclick="abrirSensor(8)"><b>Sensor<br />8</b></a>
              </div>
              <br />
              <div class="terceiraLinha2">
                <a href="#" class="sensorVerde" id="nove" onclick="abrirSensor(9)"><b>Sensor<br />9</b></a>
              </div>
            </div>
          </div>

          <!-- ZONA OESTE -->
          <div class="zonaOeste">
            <div class="sensoresZonas">
              <div class="primeiraLinha1">
                <a href="#" class="sensorVerde" id="dez" onclick="abrirSensor(10)"><b>Sensor<br />10</b></a>
                <a href="#" class="sensorVerde" id="onze" onclick="abrirSensor(11)"><b>Sensor<br />11</b></a>
              </div>
              <br />
              <div class="segundaLinha1">
                <a href="#" class="sensorVerde" id="doze" onclick="abrirSensor(12)"><b>Sensor<br />12</b></a>
              </div>
              <br />
              <div class="terceiraLinha1">
                <a href="#" class="sensorVerde" id="treze" onclick="abrirSensor(13)"><b>Sensor<br />13</b></a>
                <a href="#" class="sensorVerde" id="quatorze" onclick="abrirSensor(14)"><b>Sensor<br />14</b></a>
              </div>
            </div>
          </div>
        </div>

        <div class="container3">
          <div class="zonaLeste">
            <div class="identificacaoZonaLeste"></div>
            <div><b>Zona Leste</b></div>
          </div>
          <div class="zonaCentral">
            <div class="identificacaoZonaCentral"></div>
            <div><b>Zona Central</b></div>
          </div>
          <div class="zonaOeste">
            <div class="identificacaoZonaOeste"></div>
            <div><b>Zona Oeste</b></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container6">
    <div class="fasesrisco">
      <h2>Per√≠odo Atual</h2>
      <div id="faseAtual" class="faseAtual">Dorm√™ncia</div>
    </div>

    <div class="ideal-info">
      <h2>M√©tricas ideais por fase do cultivo</h2>
      <div class="fases2" id="fases2">
        <div id="dormencia"><b>Dorm√™ncia</b><br />5¬∞C - 15¬∞C<br />50-70%</div>
        <div id="brotacao"><b>Brota√ß√£o</b><br />15¬∞C - 25¬∞C<br />60-80%</div>
        <div id="floracao"><b>Flora√ß√£o</b><br />18¬∞C - 25¬∞C<br />50-70%</div>
        <div id="crescimento"><b>Cresc. dos Bagos</b><br />20¬∞C - 25¬∞C<br />60-80%</div>
        <div id="maturacao"><b>Matura√ß√£o</b><br />20¬∞C - 30¬∞C<br />40-60%</div>
        <div id="colheita"><b>Colheita</b><br />10¬∞C - 20¬∞C<br />80-90%</div>
      </div>
    </div>
  </div>

  <div class="container4">
    <canvas class="grafico_umidade" id="myChart"></canvas>
    <canvas class="grafico_temperatura" id="myChartline"></canvas>
  </div>

  <div class="container5">
    <div class="grafico">
      <div class="graficoAlertasContent">
        <canvas class="grafico_alertas" id="myChartdought"></canvas>
      </div>
    </div>

    <div class="historico">
      <div class="historico-header">Hist√≥rico de alertas</div>
      <div class="historico-body" id="historico-body">
        <div class="historico-row title">
          <span>Data e Hora</span>
          <span>Sensor</span>
          <span>Status</span>
          <span>Tempo em alerta</span>
        </div>
      </div>
    </div>
  </div>

<script>
// ========== VARI√ÅVEIS GLOBAIS ==========
const ID_ESTUFA = Number(sessionStorage.getItem("ID_ESTUFA")) || 1;
const TOTAL_SENSORES = 14;
const SENSORES_IDS = Array.from({length: TOTAL_SENSORES}, (_, i) => i+1);

let faseAtual = "Dorm√™ncia";

// ========== MAPAS ==========
const mapaSensores = {
  1:"um", 2:"dois", 3:"tres", 4:"quatro", 5:"cinco", 6:"seis", 7:"sete",
  8:"oito", 9:"nove", 10:"dez", 11:"onze", 12:"doze", 13:"treze", 14:"quatorze"
};

const mapaFases = {
  "Dorm√™ncia":"dormencia", "Brota√ß√£o":"brotacao", "Flora√ß√£o":"floracao",
  "Crescimento":"crescimento", "Matura√ß√£o":"maturacao", "Colheita":"colheita"
};

const mapaZonas = {
  1:"Leste", 2:"Leste", 3:"Leste", 4:"Leste", 5:"Leste",
  6:"Central", 7:"Central", 8:"Central", 9:"Central",
  10:"Oeste", 11:"Oeste", 12:"Oeste", 13:"Oeste", 14:"Oeste"
};

// ========== FUN√á√ïES UTILIT√ÅRIAS ==========
function redirecionar() {
  window.location.href = "http://localhost:8080/";
}

const formatadorBR = new Intl.DateTimeFormat('pt-BR', {
  day: '2-digit',
  month: '2-digit',
  year: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
  second: '2-digit',
  timeZone: 'America/Sao_Paulo'
});

function formatarDataHora(dataHora) {
  const d = new Date(dataHora);
  if (isNaN(d.getTime())) {
    console.error("Data inv√°lida recebida:", dataHora);
    return "Data inv√°lida";
  }
  return formatadorBR.format(d);
}

function obterFaixasPorFase(fase) {
  const faixas = {
    'Brota√ß√£o': { tMin: 15, tMax: 25, uMin: 60, uMax: 80 },
    'Crescimento': { tMin: 20, tMax: 25, uMin: 60, uMax: 80 },
    'Dorm√™ncia': { tMin: 5, tMax: 15, uMin: 50, uMax: 70 },
    'Flora√ß√£o': { tMin: 18, tMax: 25, uMin: 50, uMax: 70 },
    'Matura√ß√£o': { tMin: 20, tMax: 30, uMin: 40, uMax: 60 },
    'Colheita': { tMin: 10, tMax: 20, uMin: 80, uMax: 90 }
  };
  return faixas[fase] || faixas['Dorm√™ncia'];
}

function classificarValor(valor, min, max) {
  if (valor < min || valor > max) {
    return "CR√çTICO";
  }
  
  const centro = (min + max) / 2;
  const faixa = max - min;
  const margemModerado = faixa * 0.25;
  const distanciaDoCentro = Math.abs(valor - centro);
  
  if (distanciaDoCentro > margemModerado) {
    return "MODERADO";
  }
  
  return "IDEAL";
}

// ========== INICIALIZA√á√ÉO DOS GR√ÅFICOS ==========
Chart.defaults.font.weight = 650;

const ctxUmidade = document.getElementById("myChart");
const ctxTemperatura = document.getElementById("myChartline");
const ctxDought = document.getElementById("myChartdought");

const graficoUmidade = new Chart(ctxUmidade, {
  type: "bar",
  data: { 
    labels: [], 
    datasets: [{ 
      label: "Umidade (S = Sensores)", 
      data: [], 
      backgroundColor: "purple" 
    }] 
  },
  options: { 
    maintainAspectRatio: false, 
    scales: { y: { beginAtZero: true } } 
  }
});

const graficoTemperatura = new Chart(ctxTemperatura, {
  type: "bar",
  data: { 
    labels: [], 
    datasets: [{ 
      label: "Temperatura (S = Sensores)", 
      data: [], 
      backgroundColor: "purple" 
    }] 
  },
  options: { 
    maintainAspectRatio: false, 
    scales: { y: { beginAtZero: true } } 
  }
});

const graficoDoughnut = new Chart(ctxDought, {
  type: "doughnut",
  data: { 
    labels:["Zona Leste","Zona Central","Zona Oeste"], 
    datasets:[{
      data:[0, 0, 0], 
      backgroundColor:["#dbf2d1","#63a047","#4e6113"]
    }] 
  },
  options:{
    responsive:true, 
    plugins:{ 
      legend:{position:"top"}, 
      title:{display:true, text:"Alertas por Zona"}
    }
  }
});

// ========== FUN√á√ïES DE INTERFACE ==========
function limparHistoricoAlertas() {
  const historicoBody = document.getElementById("historico-body");
  historicoBody.querySelectorAll(".historico-row.dados").forEach(l => l.remove());
}

function adicionarLinhaHistorico(dataHora, sensor, status) {
  const dataFormatada = formatarDataHora(dataHora);
  const horarioComQuebra = dataFormatada.replace(/(.{10})/g, "$1<br>");
  
  const row = document.createElement("div");
  row.className = "historico-row dados";
  row.innerHTML = `
    <span>${horarioComQuebra}</span>
    <span>Sensor ${sensor}</span>
    <span>${status}</span>
    <span>‚Äî</span>
  `;
  
  document.getElementById("historico-body").appendChild(row);
}

// ========== FUN√á√ïES DE FASE DA ESTUFA ==========
function atualizarFaseAtual() {
  fetch(`/estufas/${ID_ESTUFA}/fase-atual`, { cache:"no-store" })
    .then(res => res.json())
    .then(dados => {
      const registro = Array.isArray(dados) ? dados[0] : dados;
      if(!registro || !registro.periodoDesenvolvimento) return;
      
      faseAtual = registro.periodoDesenvolvimento;
      document.getElementById("faseAtual").textContent = faseAtual;
      
      Object.values(mapaFases).forEach(id => {
        const div = document.getElementById(id);
        if(div) div.style.display="none";
      });
      
      const divAtual = document.getElementById(mapaFases[faseAtual]);
      if(divAtual) divAtual.style.display="block";
      
      console.log("Fase atual atualizada:", faseAtual);
    })
    .catch(erro => console.error("Erro ao atualizar fase da estufa:", erro));
}

// ========== FUN√á√ïES DE ALERTAS ==========
function verificarAlertasSensores(medidasAtuais) {
  if(!Array.isArray(medidasAtuais) || medidasAtuais.length === 0) {
    console.log("‚ö†Ô∏è Nenhuma medida dispon√≠vel para verificar alertas");
    return;
  }

  console.log(`üîç Verificando alertas de ${medidasAtuais.length} sensores`);
  
  const faixas = obterFaixasPorFase(faseAtual);
  
  medidasAtuais.forEach((medida, index) => {
    const temp = Number(medida.medidaTemp);
    const umid = Number(medida.medidaUmid);
    const idSensor = medida.idSensor;
    
    if (!idSensor) {
      console.error("‚ùå ID do sensor n√£o encontrado na medida:", medida);
      return;
    }
    
    if (isNaN(temp) || isNaN(umid)) {
      console.warn(`‚ö†Ô∏è Sensor ${idSensor}: Dados inv√°lidos - Temp=${temp}, Umid=${umid}`);
      return;
    }

    const statusTemp = classificarValor(temp, faixas.tMin, faixas.tMax);
    const statusUmid = classificarValor(umid, faixas.uMin, faixas.uMax);
    
    console.log(`‚úì Sensor ${idSensor}: Temp=${temp}¬∞C (${statusTemp}), Umid=${umid}% (${statusUmid})`);

    if (statusTemp !== "IDEAL") {
      let mensagemTemp = "";
      
      if (statusTemp === "CR√çTICO") {
        mensagemTemp = `[${faseAtual}] Sensor ${idSensor}: Temperatura (${temp.toFixed(1)}¬∞C) fora da faixa ideal (${faixas.tMin}¬∞C - ${faixas.tMax}¬∞C)`;
      } else if (statusTemp === "MODERADO") {
        mensagemTemp = `[${faseAtual}] Sensor ${idSensor}: Temperatura (${temp.toFixed(1)}¬∞C) pr√≥xima da faixa ideal`;
      }

      registrarAlertaNoServidor({
        alertaTemp: statusTemp,
        alertaUmid: null,
        fkSensorMedida: idSensor,
        mensagem: mensagemTemp
      });
    }

    if (statusUmid !== "IDEAL") {
      let mensagemUmid = "";
      
      if (statusUmid === "CR√çTICO") {
        mensagemUmid = `[${faseAtual}] Sensor ${idSensor}: Umidade (${umid.toFixed(1)}%) fora da faixa ideal (${faixas.uMin}% - ${faixas.uMax}%)`;
      } else if (statusUmid === "MODERADO") {
        mensagemUmid = `[${faseAtual}] Sensor ${idSensor}: Umidade (${umid.toFixed(1)}%) pr√≥xima da faixa ideal`;
      }

      registrarAlertaNoServidor({
        alertaTemp: null,
        alertaUmid: statusUmid,
        fkSensorMedida: idSensor,
        mensagem: mensagemUmid
      });
    }
  });

  console.log(`‚úÖ Verifica√ß√£o conclu√≠da para ${medidasAtuais.length} sensores`);
  
  setTimeout(() => carregarHistoricoDoServidor(), 1000);
}

function registrarAlertaNoServidor(alerta) {
  console.log("üì§ ENVIANDO:", JSON.stringify(alerta, null, 2));
  
  fetch("/alertas/registrar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(alerta)
  })
  .then(function (res) {
    if (res.ok) {
      res.text().then(texto => console.log("‚úì Alerta registrado:", texto));
    } else {
      res.text().then(texto => console.error(`‚úó Falha: ${res.status} ${texto}`));
    }
  })
  .catch(err => console.error("‚úó Erro:", err));
}

function carregarHistoricoDoServidor() {
  fetch(`/alertas/estufa/${ID_ESTUFA}`, { cache: "no-store" })
    .then(res => res.json())
    .then(lista => {
      if(!Array.isArray(lista) || lista.length === 0) return;
      
      limparHistoricoAlertas();

      let alertasLeste = 0, alertasCentral = 0, alertasOeste = 0;

      lista.reverse().slice(0, 20).forEach(item => {
        const alertaTemp = item.AlertaTemp || item.alertaTemp;
        const alertaUmid = item.AlertaUmid || item.alertaUmid;
        const idSensor = item.fkSensorMedida;
        
        let status = "MODERADO";
        
        if (alertaTemp) {
          const tempStr = String(alertaTemp).toUpperCase().trim();
          if (tempStr === "CR√çTICO" || tempStr === "CRITICO") {
            status = "CR√çTICO";
          }
        }
        
        if (alertaUmid) {
          const umidStr = String(alertaUmid).toUpperCase().trim();
          if (umidStr === "CR√çTICO" || umidStr === "CRITICO") {
            status = "CR√çTICO";
          }
        }

        const zona = mapaZonas[idSensor];
        if (zona === "Leste") alertasLeste++;
        else if (zona === "Central") alertasCentral++;
        else if (zona === "Oeste") alertasOeste++;

        adicionarLinhaHistorico(item.dtHrInicialAlerta, idSensor, status);
      });

      graficoDoughnut.data.datasets[0].data = [alertasLeste, alertasCentral, alertasOeste];
      graficoDoughnut.update();
    })
    .catch(err => console.error("Erro ao carregar hist√≥rico:", err));
}

// ========== FUN√á√ïES DE ATUALIZA√á√ÉO DOS SENSORES ==========
function atualizarStatusSensores() {
  fetch(`/medidas/estufa/${ID_ESTUFA}/atuais`, { cache:"no-store" })
    .then(res => res.json())
    .then(medidasAtuais => {
      if(!Array.isArray(medidasAtuais)) return;

      const faixas = obterFaixasPorFase(faseAtual);

      SENSORES_IDS.forEach(id => {
        const div = document.getElementById(mapaSensores[id]);
        if(!div) return;

        const medida = medidasAtuais.find(m => m.idSensor === id);
        if(!medida) {
          div.className = "sensorVerde";
          return;
        }

        const temp = Number(medida.medidaTemp);
        const umid = Number(medida.medidaUmid);
        
        if (isNaN(temp) || isNaN(umid)) {
          div.className = "sensorVerde";
          return;
        }

        const statusTemp = classificarValor(temp, faixas.tMin, faixas.tMax);
        const statusUmid = classificarValor(umid, faixas.uMin, faixas.uMax);

        if (statusTemp === "CR√çTICO" || statusUmid === "CR√çTICO") {
          div.className = "sensorVermelho";
        } else if (statusTemp === "MODERADO" || statusUmid === "MODERADO") {
          div.className = "sensorAmarelo";
        } else {
          div.className = "sensorVerde";
        }
      });

      verificarAlertasSensores(medidasAtuais);
    })
    .catch(erro => console.error("Erro ao atualizar status dos sensores:", erro));
}

function atualizarGraficosEstufa() {
  fetch(`/medidas/estufa/${ID_ESTUFA}/atuais`, { cache:"no-store" })
    .then(res => res.json())
    .then(dados => {
      if(!Array.isArray(dados)) return;

      graficoUmidade.data.labels = SENSORES_IDS.map(id => `S${id}`);
      graficoTemperatura.data.labels = SENSORES_IDS.map(id => `S${id}`);

      graficoUmidade.data.datasets[0].data = SENSORES_IDS.map(id => {
        const sensor = dados.find(d => d.idSensor === id) || {};
        return Number(sensor.medidaUmid) || 0;
      });

      graficoTemperatura.data.datasets[0].data = SENSORES_IDS.map(id => {
        const sensor = dados.find(d => d.idSensor === id) || {};
        return Number(sensor.medidaTemp) || 0;
      });

      graficoUmidade.update();
      graficoTemperatura.update();
    })
    .catch(erro => console.error("Erro ao atualizar gr√°ficos:", erro));
}

// ========== NAVEGA√á√ÉO ==========
function abrirSensor(idSensor) {
  console.log(`üîπ Abrindo sensor ${idSensor}`);

  sessionStorage.setItem("ID_SENSOR", idSensor);
  sessionStorage.setItem("ID_ESTUFA", ID_ESTUFA);

  window.location.href = `dashboard.html?estufa=${ID_ESTUFA}&sensor=${idSensor}`;
}

// ========== INICIALIZA√á√ÉO ==========
window.onload = () => {
  atualizarFaseAtual();
  atualizarGraficosEstufa();
  atualizarStatusSensores();
  carregarHistoricoDoServidor();
  adicionarLinhaHistorico()

  setInterval(() => {
    atualizarFaseAtual();
    atualizarGraficosEstufa();
    atualizarStatusSensores();
     adicionarLinhaHistorico()
  }, 5000);
  
  setInterval(() => carregarHistoricoDoServidor(), 10000);
};
</script>
</body>
</html>